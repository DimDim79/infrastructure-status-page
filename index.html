<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lift & Shift Status</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
</head>
<body>
    <div class="container">
        <header>
            <h1>Infrastructure Lift & Shift Status</h1>
            <div class="current-status" id="currentStatus">
                <div class="status-indicator operational" id="statusIndicator"></div>
                <span id="statusText">Migration In Progress</span>
            </div>
        </header>

        <main>
            <section class="timeline-section">
                <h2>30-Day Timeline</h2>
                <div class="timeline-grid" id="timelineGrid">
                    <!-- Timeline will be generated here -->
                </div>
            </section>

            <section class="updates-section">
                <h2>Recent Updates</h2>
                <div class="updates-container" id="updatesContainer">
                    <div class="loading">Loading updates...</div>
                </div>
            </section>
        </main>

        <footer>
            <p>Last updated: <span id="lastUpdated">Loading...</span></p>
            <p>Auto-refresh enabled (60s)</p>
        </footer>
    </div>

    <script>
        let updates = [];
        let refreshInterval;

        // Status types and their corresponding classes
        const statusTypes = {
            'operational': { class: 'operational', text: 'All Systems Operational' },
            'maintenance': { class: 'maintenance', text: 'Scheduled Maintenance' },
            'degraded': { class: 'degraded', text: 'Degraded Performance' },
            'partial': { class: 'partial', text: 'Partial Outage' },
            'major': { class: 'major', text: 'Major Outage' }
        };

        // Severity levels
        const severityLevels = {
            'low': { class: 'severity-low', text: 'Low' },
            'medium': { class: 'severity-medium', text: 'Medium' },
            'high': { class: 'severity-high', text: 'High' },
            'critical': { class: 'severity-critical', text: 'Critical' }
        };

        async function loadUpdates() {
            try {
                const response = await fetch('updates.json?t=' + Date.now());
                const data = await response.json();
                updates = data.updates || [];

                updateCurrentStatus();
                renderTimeline();
                renderUpdates();
                updateLastRefresh();
            } catch (error) {
                console.error('Error loading updates:', error);
                document.getElementById('updatesContainer').innerHTML =
                    '<div class="error">Failed to load updates. Please try again later.</div>';
            }
        }

        function updateCurrentStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            // Find the most recent update to determine current status
            const recentUpdate = updates.find(update => !update.resolved) ||
                                updates.find(update => update.status === 'ongoing') ||
                                { status: 'operational' };

            const currentStatus = recentUpdate.status || 'operational';
            const statusInfo = statusTypes[currentStatus] || statusTypes['operational'];

            statusIndicator.className = 'status-indicator ' + statusInfo.class;
            statusText.textContent = statusInfo.text;
        }

        function renderTimeline() {
            const timelineGrid = document.getElementById('timelineGrid');
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            let timelineHTML = '';

            for (let i = 0; i < 30; i++) {
                const date = new Date(thirtyDaysAgo.getTime() + (i * 24 * 60 * 60 * 1000));
                const dateStr = date.toISOString().split('T')[0];

                // Check if there were any incidents on this date
                const dayIncidents = updates.filter(update => {
                    const updateDate = new Date(update.timestamp).toISOString().split('T')[0];
                    return updateDate === dateStr;
                });

                let dayClass = 'operational';
                let tooltip = 'No incidents';

                if (dayIncidents.length > 0) {
                    const severestIncident = dayIncidents.reduce((prev, current) => {
                        const severityOrder = ['low', 'medium', 'high', 'critical'];
                        return severityOrder.indexOf(current.severity) > severityOrder.indexOf(prev.severity) ? current : prev;
                    });

                    dayClass = severityLevels[severestIncident.severity].class.replace('severity-', '');
                    tooltip = `${dayIncidents.length} incident(s) - ${severestIncident.title}`;
                }

                timelineHTML += `
                    <div class="timeline-day ${dayClass}"
                         data-date="${dateStr}"
                         title="${tooltip}">
                        <span class="day-number">${date.getDate()}</span>
                    </div>
                `;
            }

            timelineGrid.innerHTML = timelineHTML;
        }

        function renderUpdates() {
            const container = document.getElementById('updatesContainer');

            if (updates.length === 0) {
                container.innerHTML = '<div class="no-updates">No updates available.</div>';
                return;
            }

            // Sort updates by timestamp (newest first)
            const sortedUpdates = [...updates].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const updatesHTML = sortedUpdates.map(update => {
                const date = new Date(update.timestamp);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const formattedTime = date.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const severityInfo = severityLevels[update.severity] || severityLevels['low'];
                const statusInfo = statusTypes[update.status] || statusTypes['operational'];

                return `
                    <div class="update-item ${update.resolved ? 'resolved' : ''}">
                        <div class="update-header">
                            <div class="update-title">
                                <h3>${update.title}</h3>
                                <div class="update-badges">
                                    <span class="severity-badge ${severityInfo.class}">${severityInfo.text}</span>
                                    <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
                                </div>
                            </div>
                            <div class="update-time">
                                <span class="date">${formattedDate}</span>
                                <span class="time">${formattedTime}</span>
                            </div>
                        </div>
                        <div class="update-description">
                            ${update.description}
                        </div>
                        ${update.services ? `
                            <div class="affected-services">
                                <strong>Affected Areas:</strong> ${update.services.join(', ')}
                            </div>
                        ` : ''}
                        ${update.resolved ? `
                            <div class="resolution-info">
                                <strong>Resolved:</strong> ${new Date(update.resolvedAt).toLocaleString()}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = updatesHTML;
        }

        function updateLastRefresh() {
            const now = new Date();
            const formattedTime = now.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdated').textContent = formattedTime;
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(loadUpdates, 60000); // Refresh every 60 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        // Handle visibility change to pause/resume refresh when tab is not visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
                loadUpdates(); // Immediate refresh when tab becomes visible
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUpdates();
            startAutoRefresh();
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>